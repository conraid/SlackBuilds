From ac42a857038f91c3b796cdbf0f7213b33d70e1b4 Mon Sep 17 00:00:00 2001
From: Mike Wang <mikewang000000@gmail.com>
Date: Thu, 6 Feb 2025 03:14:57 +0800
Subject: [PATCH] fix: Replace deprecated FFmpeg avfft.h APIs

---
 src/spek-fft.cc | 28 +++++++++++++++++++++++++++-
 src/spek-fft.h  |  2 +-
 2 files changed, 28 insertions(+), 2 deletions(-)

diff --git a/src/spek-fft.cc b/src/spek-fft.cc
index 3105213..fca30b0 100644
--- a/src/spek-fft.cc
+++ b/src/spek-fft.cc
@@ -2,7 +2,13 @@

 #define __STDC_CONSTANT_MACROS
 extern "C" {
+#include <libavutil/version.h>
+#if LIBAVUTIL_VERSION_INT >= AV_VERSION_INT(58, 18, 100)
+#define USE_LIBAVUTIL_TX_API
+#include <libavutil/tx.h>
+#else
 #include <libavcodec/avfft.h>
+#endif
 }

 #include "spek-fft.h"
@@ -16,7 +22,12 @@ public:
     void execute() override;

 private:
+#ifdef USE_LIBAVUTIL_TX_API
+    struct AVTXContext *cx;
+    av_tx_fn tx_func;
+#else
     struct RDFTContext *cx;
+#endif
 };

 std::unique_ptr<FFTPlan> FFT::create(int nbits)
@@ -24,18 +35,33 @@ std::unique_ptr<FFTPlan> FFT::create(int nbits)
     return std::unique_ptr<FFTPlan>(new FFTPlanImpl(nbits));
 }

-FFTPlanImpl::FFTPlanImpl(int nbits) : FFTPlan(nbits), cx(av_rdft_init(nbits, DFT_R2C))
+FFTPlanImpl::FFTPlanImpl(int nbits) : FFTPlan(nbits)
 {
+#ifdef USE_LIBAVUTIL_TX_API
+    const float scale = 1.f;
+    av_tx_init(&this->cx, &this->tx_func, AV_TX_FLOAT_RDFT, 0, 1 << nbits, &scale, AV_TX_INPLACE);
+#else
+    this->cx = av_rdft_init(nbits, DFT_R2C);
+#endif
 }

 FFTPlanImpl::~FFTPlanImpl()
 {
+#ifdef USE_LIBAVUTIL_TX_API
+    av_tx_uninit(&this->cx);
+#else
     av_rdft_end(this->cx);
+#endif
 }

 void FFTPlanImpl::execute()
 {
+#ifdef USE_LIBAVUTIL_TX_API
+    float *input = this->get_input();
+    this->tx_func(this->cx, input, input, sizeof(float));
+#else
     av_rdft_calc(this->cx, this->get_input());
+#endif

     // Calculate magnitudes.
     int n = this->get_input_size();
diff --git a/src/spek-fft.h b/src/spek-fft.h
index 409263e..9a16c87 100644
--- a/src/spek-fft.h
+++ b/src/spek-fft.h
@@ -26,7 +26,7 @@ public:
     {
         // FFmpeg uses various assembly optimizations which expect
         // input data to be aligned by up to 32 bytes (e.g. AVX)
-        this->input = (float*) av_malloc(sizeof(float) * input_size);
+        this->input = (float*) av_malloc(sizeof(float) * (input_size + 2));
     }

     virtual ~FFTPlan()
